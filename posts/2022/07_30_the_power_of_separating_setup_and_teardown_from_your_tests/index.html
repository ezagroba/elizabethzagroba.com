<!DOCTYPE html>
<html prefix="og: http://ogp.me/ns# article: http://ogp.me/ns/article#
" lang="en">
<head>
<meta charset="utf-8">
<meta name="description" content="Pytest gives you a failure in the test, and an error on setup or teardown.">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>The Power of Separating Setup and Teardown From Your Tests | Elizabeth Zagroba: Organizational Anarchist</title>
<link href="../../../assets/css/all-nocdn.css" rel="stylesheet" type="text/css">
<meta name="theme-color" content="#5670d4">
<meta name="generator" content="Nikola (getnikola.com)">
<link rel="alternate" type="application/rss+xml" title="RSS" hreflang="en" href="../../../rss.xml">
<link rel="canonical" href="https://elizabethzagroba.com/posts/2022/07_30_the_power_of_separating_setup_and_teardown_from_your_tests/">
<link rel="icon" href="../../../images/avatar.png" sizes="128x128">
<!--[if lt IE 9]><script src="../../../assets/js/html5.js"></script><![endif]--><link href="../../assets/fontawesome-5.13.0/css/all.css" rel="stylesheet">
<script>var clicky_site_ids = clicky_site_ids || []; clicky_site_ids.push(101248614);</script><script async src="//static.getclicky.com/js"></script><meta name="author" content="Elizabeth Zagroba">
<link rel="prev" href="../07_02_llewt/" title="The Llandegfan Exploratory Workshop on Testing" type="text/html">
<link rel="next" href="../08_13_amateur_professional_career_coach/" title="Amateur Professional Career Coach" type="text/html">
<meta property="og:site_name" content="Elizabeth Zagroba: Organizational Anarchist">
<meta property="og:title" content="The Power of Separating Setup and Teardown From Your Tests">
<meta property="og:url" content="https://elizabethzagroba.com/posts/2022/07_30_the_power_of_separating_setup_and_teardown_from_your_tests/">
<meta property="og:description" content="Pytest gives you a failure in the test, and an error on setup or teardown.">
<meta property="og:type" content="article">
<meta property="article:published_time" content="2022-07-30T00:00:00+02:00">
<meta property="article:tag" content="pytest">
<meta property="article:tag" content="python">
<meta property="article:tag" content="testing">
<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@ezagroba">
<meta name="twitter:creator" content="@ezagroba">
</head>
<body>
<a href="#content" class="sr-only sr-only-focusable">Skip to main content</a>

<!-- Menubar -->

<nav class="navbar navbar-expand-md static-top mb-4
navbar-dark
bg-dark
"><div class="container">
<!-- This keeps the margins nice -->
        <a class="navbar-brand" href="../../../">

            <span id="blog-title">Elizabeth Zagroba: Organizational Anarchist</span>
        </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#bs-navbar" aria-controls="bs-navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="bs-navbar">
            <ul class="navbar-nav mr-auto">
<li class="nav-item dropdown">
<a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">Blog</a>
            <div class="dropdown-menu">
                    <a href="../../../archive.html" class="dropdown-item">Archive</a>
                    <a href="../../../categories/index.html" class="dropdown-item">Tags</a>
                    <a href="../../../rss.xml" class="dropdown-item">RSS feed</a>
            </div>
                </li>
<li class="nav-item">
<a href="../../../pages/work" class="nav-link">Work</a>
                </li>
<li class="nav-item">
<a href="../../../pages/speaking" class="nav-link">Speaking</a>
                </li>
<li class="nav-item">
<a href="../../../pages/resources" class="nav-link">Resources</a>

                
            </li>
</ul>
<!-- DuckDuckGo custom search --><form method="get" id="search" action="https://duckduckgo.com/" class="navbar-form pull-left">
<input type="hidden" name="sites" value="https://elizabethzagroba.com/"><input type="hidden" name="k8" value="#444444"><input type="hidden" name="k9" value="#D51920"><input type="hidden" name="kt" value="h"><input type="text" name="q" maxlength="255" placeholder="Search" class="span2" style="margin-top: 4px;"><input type="submit" value="DuckDuckGo Search" style="visibility: hidden;">
</form>
<!-- End of custom search -->


            <ul class="navbar-nav navbar-right"></ul>
</div>
<!-- /.navbar-collapse -->
    </div>
<!-- /.container -->
</nav><!-- End of Menubar --><div class="container" id="content" role="main">
    <div class="body-content">
        <!--Body content-->
        
        
        
<article class="post-text h-entry hentry postpage" itemscope="itemscope" itemtype="http://schema.org/Article"><header><h1 class="p-name entry-title" itemprop="headline name"><a href="." class="u-url">The Power of Separating Setup and Teardown From Your Tests</a></h1>

        <div class="metadata">
            <p class="byline author vcard p-author h-card"><span class="byline-name fn p-name" itemprop="author">
                    Elizabeth Zagroba
            </span></p>
            <p class="dateline">
            <a href="." rel="bookmark">
            <time class="published dt-published" datetime="2022-07-30T00:00:00+02:00" itemprop="datePublished" title="30 July 2022">30 July 2022</time></a>
            </p>
            

        </div>
        

    </header><div class="e-content entry-content" itemprop="articleBody text">
    <p>This week, I was trying to find an explanation for my colleagues about when it's better to separate the setup and teardown of your tests from the test code itself. I was hoping that pytest's own documentation would have a recommendation, since our test code for this particular repository is written in Python with pytest as a test runner. Pytest does explain <a href="https://docs.pytest.org/en/7.1.x/how-to/fixtures.html">many features of fixtures</a>, and <a href="https://docs.pytest.org/en/7.1.x/how-to/fixtures.html">what different test output can look like</a>, but not the power of combining them. That's what I'd like to explain here. </p>
<h3>An example</h3>
<p>I can't show you the code I was looking at from work, so here is a relatively trivial and useless example I was able to contrive in an hour. (Sidebar: I once tested an address field that truncated the leading zeroes of post codes, so though this test may be trivial, testing that the post code made it to the database intact can provide value.)</p>
<p>There's an API called Zippopotamus that can either:
1. take a city and state, and return you details about matching places; or
2. take a post code, and return you details about matching places.</p>
<p>I've got two tests below, both trying to accomplish the same thing: see if all the post codes returned for the city of Waterville in the state of Maine also include Waterville in their results. </p>
<ul>
<li>Setup: get list of post codes for Waterville, Maine</li>
<li>Test: for each post code, check that <code>Waterville</code> is in the list of matching places</li>
</ul>
<pre class="code literal-block"><span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">import</span> <span class="nn">pytest</span>

<span class="n">zippopotamus_url</span> <span class="o">=</span> <span class="s2">"https://api.zippopotam.us/us"</span>


<span class="nd">@pytest</span><span class="o">.</span><span class="n">fixture</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">post_codes</span><span class="p">():</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">zippopotamus_url</span><span class="si">}</span><span class="s1">/me/waterville'</span><span class="p">)</span>
    <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
    <span class="n">places</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'places'</span><span class="p">]</span>
    <span class="n">post_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">place</span><span class="p">[</span><span class="s1">'post code'</span><span class="p">]</span> <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">post_codes</span>


<span class="k">class</span> <span class="nc">TestZippopotamus</span><span class="p">:</span>

    <span class="k">def</span> <span class="nf">test_setup_included_waterville_maine_included_in_each_post_code</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">zippopotamus_url</span><span class="si">}</span><span class="s1">/me/waterville'</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
        <span class="n">places</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'places'</span><span class="p">]</span>
        <span class="n">post_codes</span> <span class="o">=</span> <span class="p">[</span><span class="n">place</span><span class="p">[</span><span class="s1">'post code'</span><span class="p">]</span> <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">post_code</span> <span class="ow">in</span> <span class="n">post_codes</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">zippopotamus_url</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">post_code</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">places</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'places'</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">place</span><span class="p">[</span><span class="s1">'place name'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Waterville'</span> <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_setup_separated_waterville_maine_included_in_each_post_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">post_codes</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">post_code</span> <span class="ow">in</span> <span class="n">post_codes</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="sa">f</span><span class="s1">'</span><span class="si">{</span><span class="n">zippopotamus_url</span><span class="si">}</span><span class="s1">/</span><span class="si">{</span><span class="n">post_code</span><span class="si">}</span><span class="s1">'</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">==</span> <span class="mi">200</span>
            <span class="n">places</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s1">'places'</span><span class="p">]</span>
            <span class="k">assert</span> <span class="nb">any</span><span class="p">(</span><span class="n">place</span><span class="p">[</span><span class="s1">'place name'</span><span class="p">]</span> <span class="o">==</span> <span class="s1">'Waterville'</span> <span class="k">for</span> <span class="n">place</span> <span class="ow">in</span> <span class="n">places</span><span class="p">)</span>
</pre>
<p>The first test shows the setup included in the test. The second test has the setup separated from the test. It appears in the fixture called <code>post_codes</code>. </p>
<pre class="code literal-block"><span class="o">(</span>venv<span class="o">)</span> ez@EZ-mini blog-examples % <span class="nv">pytest</span>                     
<span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===========================</span>
platform darwin -- Python <span class="m">3</span>.10.1, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/ez/blog-examples
collected <span class="m">2</span> items                                                        

test_error_vs_failure_pytest.py ..                                 <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">===========================</span> <span class="m">2</span> passed <span class="k">in</span> <span class="m">1</span>.46s <span class="o">============================</span>
</pre>
<p>When you run these tests, they both pass. One test is a little longer, which you may find easier to follow than navigating around in the code, or harder to follow because there's code that's more about data collection than what we want to test. I find it yucky (a technical term) to have more than one thing called <code>request</code> or <code>response</code> in a single test, but these are all personal preferences. </p>
<p>Now imagine instead of <code>waterville</code> in the API requests, I've gone on auto-pilot and typed <code>whatever</code> in the setup for the tests. Here's what pytest gives us as the output. </p>
<pre class="code literal-block"><span class="o">(</span>venv<span class="o">)</span> ez@EZ-mini blog-examples % <span class="nv">pytest</span>
<span class="o">==========================</span> <span class="nb">test</span> session <span class="nv">starts</span> <span class="o">===========================</span>
platform darwin -- Python <span class="m">3</span>.10.1, pytest-7.1.2, pluggy-1.0.0
rootdir: /Users/ez/blog-examples
collected <span class="m">2</span> items                                                        

test_error_vs_failure_pytest.py FE                                 <span class="o">[</span><span class="m">100</span>%<span class="o">]</span>

<span class="o">=================================</span> <span class="nv">ERRORS</span> <span class="o">=================================</span>
_ ERROR at setup of TestZippopotamus.test_setup_separated_waterville_maine_included_in_each_post_code _

    @pytest.fixture<span class="o">()</span>
    def post_codes<span class="o">()</span>:
        <span class="nv">response</span> <span class="o">=</span> requests.get<span class="o">(</span>f<span class="s1">'{zippopotamus_url}/me/whatever'</span><span class="o">)</span>
&gt;       assert response.status_code <span class="o">==</span> <span class="m">200</span>
E       assert <span class="nv">404</span> <span class="o">==</span> <span class="m">200</span>
E        +  where <span class="nv">404</span> <span class="o">=</span> &lt;Response <span class="o">[</span><span class="m">404</span><span class="o">]</span>&gt;.status_code

test_error_vs_failure_pytest.py:10: <span class="nv">AssertionError</span>
<span class="o">================================</span> <span class="nv">FAILURES</span> <span class="o">================================</span>
_ TestZippopotamus.test_setup_included_waterville_maine_included_in_each_post_code _

<span class="nv">self</span> <span class="o">=</span> &lt;test_error_vs_failure_pytest.TestZippopotamus object at 0x101f4c160&gt;

    def test_setup_included_waterville_maine_included_in_each_post_code<span class="o">(</span>self<span class="o">)</span>:
        <span class="nv">response</span> <span class="o">=</span> requests.get<span class="o">(</span>f<span class="s1">'{zippopotamus_url}/me/whatever'</span><span class="o">)</span>
&gt;       assert response.status_code <span class="o">==</span> <span class="m">200</span>
E       assert <span class="nv">404</span> <span class="o">==</span> <span class="m">200</span>
E        +  where <span class="nv">404</span> <span class="o">=</span> &lt;Response <span class="o">[</span><span class="m">404</span><span class="o">]</span>&gt;.status_code

test_error_vs_failure_pytest.py:20: <span class="nv">AssertionError</span>
<span class="o">========================</span> short <span class="nb">test</span> summary <span class="nv">info</span> <span class="o">=========================</span>
FAILED test_error_vs_failure_pytest.py::TestZippopotamus::test_setup_included_waterville_maine_included_in_each_post_code
ERROR test_error_vs_failure_pytest.py::TestZippopotamus::test_setup_separated_waterville_maine_included_in_each_post_code
<span class="o">=======================</span> <span class="m">1</span> failed, <span class="m">1</span> error <span class="k">in</span> <span class="m">0</span>.71s <span class="o">=======================</span>
</pre>
<p>Neither test passes. They both get mad at the same spot, where they're checking that they got the post codes for "Whatever, Maine" and found that, oh wait no, they haven't been able to do that. </p>
<p>But one test fails and one test errors: The test with the setup included fails. The test with the setup in the fixture errors. This difference is why I prefer to separate my setup (and teardown, which behaves the same way) from my test code. </p>
<h3>The power of separating setup and teardown from your tests</h3>
<ol>
<li>
<p>More of the test code is about what's being tested, instead of being about how you get to the right place.</p>
</li>
<li>
<p>Pytest will give you an error when code fails in the setup or teardown, and a failure when the code inside the test fails.</p>
</li>
<li>
<p>If you're reusing setup or teardown, you'll only have to fix an issue in the code in one spot.</p>
</li>
<li>
<p>If you're running a bunch of tests with shared setup or teardown in a pipeline, it'll be easier to diagnose when something outside what you're trying to test has gone awry. </p>
</li>
</ol>
<h3>Reasons to keep the setup and teardown with your tests</h3>
<ol>
<li>
<p>You are early enough in the development process that the setup and teardown don't need to be used anywhere else yet. You can extract them when they do, but for now, it's a little faster to read with everything in one place.</p>
</li>
<li>
<p>If you don't have your IDE setup correctly, PyCharm may not let you Ctrl + click through the code to follow the fixture code. (<a href="https://www.jetbrains.com/help/pycharm/testing-frameworks.html#a036958d">Here's how to setup PyCharm to recognize pytest fixtures.</a>)</p>
</li>
<li>
<p>If you don't trust someone reading or debugging the test (other colleagues, future you, or possibly even other colleagues after you've moved to a different team) to be able to follow the code through to the fixtures. Or no one else is looking at the code!</p>
</li>
</ol>
<h3>What have I missed?</h3>
<p>What other reasons are there? What do you tend to do for your team when your code is shared? What do you tend to do for yourself when you only have your future self to help out? How would you have written this Python code differently? Which articles do you point to when you're explaining a separation of concerns? </p>
    </div>
    <aside class="postpromonav"><nav><ul itemprop="keywords" class="tags">
<li><a class="tag p-category" href="../../../categories/pytest/" rel="tag">pytest</a></li>
            <li><a class="tag p-category" href="../../../categories/python/" rel="tag">python</a></li>
            <li><a class="tag p-category" href="../../../categories/testing/" rel="tag">testing</a></li>
        </ul>
<ul class="pager hidden-print">
<li class="previous">
                <a href="../07_02_llewt/" rel="prev" title="The Llandegfan Exploratory Workshop on Testing">Previous post</a>
            </li>
            <li class="next">
                <a href="../08_13_amateur_professional_career_coach/" rel="next" title="Amateur Professional Career Coach">Next post</a>
            </li>
        </ul></nav></aside></article><!--End of body content--><footer id="footer"><a href="https://twitter.com/ezagroba" target="_blank"><i class="fab fa-twitter" aria-hidden="true"></i></a>
<a href="https://www.linkedin.com/in/ezagroba/" target="_blank"><i class="fab fa-linkedin" aria-hidden="true"></i></a>
<a href="https://github.com/ezagroba" target="_blank"><i class="fab fa-github" aria-hidden="true"></i></a>
<a href="https://getpocket.com/@9b7TbAd9gtTk0p78b5db22ada1pTgyj954byf8p770kRW3IZ220x4n8ad08qVbd1" target="_blank"><i class="fab fa-get-pocket" aria-hidden="true"></i></a>
<a href="https://app.thestorygraph.com/profile/e_z" target="_blank"><i class="fa fa-book-open"></i></a>
<a href="https://mas.to/@ezagroba" target="_blank"><i class="fab fa-mastodon" aria-hidden="true"></i></a>
Â© 2022 <a href="mailto:me@elizabethzagroba.com">Elizabeth Zagroba</a>. 
Powered by <a href="https://getnikola.com" rel="nofollow" target="_blank">Nikola</a>. 
<a href="https://www.mozilla.org/en-US/MPL/2.0/" target="_blank">Mozilla Public License 2.0.</a>

            
            
        </footer>
</div>
</div>


        <script src="../../../assets/js/all-nocdn.js"></script><script>
    baguetteBox.run('div#content', {
        ignoreClass: 'islink',
        captions: function(element){var i=element.getElementsByTagName('img')[0];return i===undefined?'':i.alt;}});
    </script>
</body>
</html>
